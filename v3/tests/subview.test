#!/usr/bin/env tclkit
# viewsubview tests

source [file join [file dir [info script]] initests.tcl]

# %renumber<^\s*test >%

test 0 {load ratcl} {
  package require ratcl
} 3

test 1 {view exists} -body {
  view
} -returnCodes error -result {wrong # args: should be "view v ... | ..."}

test 2 {construct subview via grouping} {
  set v [view {A B C} vdef {1 2 3 11 22 33} | group V]
  list [view $v names] [view $v structure] [vget $v 0 V * *]
} {V (SSS) {1 2 3 11 22 33}}

test 3 {subview must point to parent} {
  vget $v 0 V
} {at {group {vdef {A B C} {1 2 3 11 22 33}} V} 0 0}

test 4 {construct subview via nested vdef} {
  set w [view {{V {A B C}}} vdef [list [view {A B C} vdef {1 2 3 11 22 33}]]]
  list [view $w names] [view $w structure] [vget $w 0 V * *]
} {V (SSS) {1 2 3 11 22 33}}

test 5 {subview access must be tied to parent} {
  vget $w 0 V
} {at {vdef {{V {A B C}}} {{vdef {A B C} {1 2 3 11 22 33}}}} 0 0}

test 6 {grouped subview access must be tied to parent} {
  set w [view {{V1 {V {A B C}}}} vdef [list $v]]
  vget $w 0 V1
} {at {vdef {{V1 {V {A B C}}}} {{group {vdef {A B C} {1 2 3 11 22 33}} V}}} 0 0}

test 7 {nested subview structure was wrong} {
  list [view $v structure] [view $v struct_mk]
} {(SSS) {V[A:S,B:S,C:S]}}

test 8 {nested subview structure was wrong} {
  set w [view {{V1 {{V {A B C}}}}} vdef [list $v]]
  list [view $w structure] [view $w struct_mk]
} {((SSS)) {V1[V[A:S,B:S,C:S]]}}

test 9 {nested grouped subview access must still be tied to parent} -body {
  vget $w 0 V1 0 V
} -match glob -result {at {at {vdef {{V1 {{V {A B C}}}}} {{group *}}} 0 0} 0 0}

test 10 {frozen subview must point to parent} -body {
  set v [view $v freeze]
  vget $v 0 V
} -match glob -result {at {load *} 0 0}

test 11 {nested frozen subview must point to parent} -body {
  set w [view $w freeze]
  vget $w 0 V1 0 V
} -match glob -result {at {at {load *} 0 0} 0 0}

test 12 {nested reference must point to parent} {
  view w ref | get 0 V1 0 V
} {at {at {ref w} 0 0} 0 0}

test 13 {verify nested reference return values} {
  view w ref | get 0 V1 0 V * *
} {1 2 3 11 22 33}

unset w

::tcltest::cleanupTests
