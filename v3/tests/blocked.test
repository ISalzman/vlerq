#!/usr/bin/env tclkit
# blocked view tests

source [file join [file dir [info script]] initests.tcl]

# %renumber<^\s*test >%

test 0 {load ratcl} {
  package require ratcl
} 3

test 1 {view exists} -body {
  view
} -returnCodes error -result {wrong # args: should be "view v ... | ..."}

test 2 {structure of sample mkblk.db file} {
  set bdb [view [file dirname [info script]]/mkblk.db mapf]
  view $bdb structure
} ((II))

test 3 {blocked view has 3 blocks} {
  view $bdb get 0 bv #
} 4

test 4 {blocked view structure and size} {
  set v [view $bdb get 0 bv | blocked]
  list [view $v names] [view $v structure] [view $v get #]
} {{k1 k2} II 2500}

test 5 {block sizes} {
  view $bdb get 0 bv | counts _B
} {999 999 500 2}

test 6 {contents of last block} {
  view $bdb get 0 bv -1 _B *
} {{999 -999} {1999 -1999}}

test 7 {blocked view access} {
  foreach x {0 1 998 999 1000 1998 1999 2000 2498 2499} {
    lappend k1 [vget $v $x k1]
    lappend k2 [vget $v $x k2]
  }
  list $k1 $k2
} {{0 1 998 999 1000 1998 1999 2000 2498 2499}\
   {0 -1 -998 -999 -1000 -1998 -1999 -2000 -2498 -2499}}
  
::tcltest::cleanupTests
