#!/usr/bin/env tclkit
# view reference tests

source [file join [file dir [info script]] initests.tcl]

# %renumber<^\s*test >%

test 0 {load ratcl} {
  package require ratcl
} 3

test 1 {view exists} -body {
  view
} -returnCodes error -result {wrong # args: should be "view v ... | ..."}

set v [view {A B C} vdef {1 2 3 11 22 33 111 222 333}]

test 2 {verify contents} {
  list [view $v names] [view $v structure] [vget $v]
} {{A B C} SSS {1 2 3 11 22 33 111 222 333}}
  
test 3 {ref access} {
  set w {ref v}
  list [view $w names] [view $w structure] [vget $w]
} {{A B C} SSS {1 2 3 11 22 33 111 222 333}}
  
test 4 {changed ref access} {
  set v [view {A B C} vdef {1 2 3 11 22 33 111 222 333 1111 2222 3333}]
  list [view $w names] [view $w structure] [vget $w]
} {{A B C} SSS {1 2 3 11 22 33 111 222 333 1111 2222 3333}}

test 5 {w as string is still a reference} {
  list [vlerq::vinfo $w] $w
} {{bytes -1 type view refs 2} {ref v}}

test 6 {modify a reference} {
  view $w set 1 B x22 | get
} {1 2 3 11 x22 33 111 222 333 1111 2222 3333}

test 7 {check that the change is sticky} {
  view $w get
} {1 2 3 11 x22 33 111 222 333 1111 2222 3333}
  
test 8 {check that referenced var has changed} {
  view $v get
} {1 2 3 11 x22 33 111 222 333 1111 2222 3333}
  
test 9 {w as string is still a reference} {
  list [vlerq::vinfo $w] $w
} {{bytes -1 type view refs 2} {ref v}}

test 10 {modify another} {
  view $w set 1 C y33 | get
} {1 2 3 11 x22 y33 111 222 333 1111 2222 3333}

test 11 {check that the change is again sticky} {
  view $w get
} {1 2 3 11 x22 y33 111 222 333 1111 2222 3333}
  
test 12 {check that referenced var has changed} {
  view $v get
} {1 2 3 11 x22 y33 111 222 333 1111 2222 3333}
  
test 13 {modify again} {
  view $w set 1 C z33 | get
} {1 2 3 11 x22 z33 111 222 333 1111 2222 3333}

test 14 {check that the change is again sticky} {
  view $w get
} {1 2 3 11 x22 z33 111 222 333 1111 2222 3333}
  
test 15 {check that referenced var has changed} {
  view $v get
} {1 2 3 11 x22 z33 111 222 333 1111 2222 3333}
  
test 16 {delete from a reference} {
  view $w delete 2 1 | get
} {1 2 3 11 x22 z33 1111 2222 3333}

test 17 {check that the deletion is sticky} {
  view $w get
} {1 2 3 11 x22 z33 1111 2222 3333}
  
test 18 {check that referenced var has changed} {
  view $v get
} {1 2 3 11 x22 z33 1111 2222 3333}
  
test 19 {insert in a reference} {
  view $w insert 1 [view {A B C} vdef {A B C}] | get
} {1 2 3 A B C 11 x22 z33 1111 2222 3333}

test 20 {check that the insertion is sticky} {
  view $w get
} {1 2 3 A B C 11 x22 z33 1111 2222 3333}
  
test 21 {check that referenced var has changed} {
  view $v get
} {1 2 3 A B C 11 x22 z33 1111 2222 3333}

set v $v  
unset v

::tcltest::cleanupTests
