#!/usr/bin/env tclkit
# test suite for the vfs::m2m driver

source [file join [file dir [info script]] initests.tcl]

# %renumber<^\s*test >%

test 0 {load extension} vfs {
  package require vfs::m2m
} 1.6

test 1 {} vfs {
  vfs::m2m::Mount "" mem
} {m2m}

test 2 {} vfs {
  ::vfs::filesystem unmount mem
  # TODO: detect repeated mounts, should probably be an error
  vfs::m2m::Mount m2m.tmp mem
} {m2m}

test 3 {} vfs {
  glob -nocomplain mem/*
} {}

test 4 {} -constraints vfs -body {
  set fd [open mem/aa w]
} -match regexp -result {^(rechan\d+|mem\d+)$}

test 5 {} vfs {
  glob -nocomplain mem/*
} mem/aa

test 6 {} vfs {
  file size mem/aa
} 0

test 7 {} vfs {
  puts -nonewline $fd haha
  close $fd
  file size mem/aa
} 4

test 8 {} vfs {
  file mkdir mem/d
} {}

test 9 {} vfs {
  set fd [open mem/d/ff w]
  puts -nonewline $fd wow
  close $fd
  file size mem/d/ff
} 3

test 10 {} vfs {
  set fd [open mem/d/eee w]
  puts -nonewline $fd "Hello world!"
  close $fd
  file size mem/d/eee
} 12

test 11 {} vfs {
  glob mem/*
} {mem/aa mem/d}

test 12 {} vfs {
  glob mem/d/*
} {mem/d/ff mem/d/eee}

test 13 {} vfs {
  file delete m2m.tmp
  vfs::unmount mem
} {}

test 14 {} vfs {
  file size m2m.tmp
} 205

test 15 {} vfs {
  #puts [exec hexdump -C m2m.tmp]
  file delete m2m.tmp
} {}

::tcltest::cleanupTests
