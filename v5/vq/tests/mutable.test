#!/usr/bin/env tclkit
# %renumber<^\s*test >%

# nullable module tests

source [file join [file dir [info script]] initests.tcl]

test 0 {load package} {
    package require vq
} $version

test 1 {simple meta-table} {
    set m [vq new [vq meta ""]]
    vq set @m 0 0 x
    vq set @m 0 1 5
    set m
} {mutable @m {} {} {} {0 1} {0 1} x {0 1} {0 1} 5 {}}

test 2 {modify meta-table} {
    vq set @m 0 0 y
    set m
} {mutable @m {} {} {} {0 1} {0 1} y {0 1} {0 1} 5 {}}

test 3 {simple empty table} {
    set t [vq new $m]
} {data {mutable @m {} {} {} {0 1} {0 1} y {0 1} {0 1} 5 {}} 0}

test 4 {modify must not alter original when shared} {
    vq set @t 0 0 a
    set o $t
    vq set @t 0 0 b
    list $o $t
} {{mutable @t {} {} {} {0 1} {0 1} a} {mutable @t {} {} {} {0 1} {0 1} b}}

test 5 {setup meta-table} {
    set m [vq new [vq meta ""]]
    set col 0
    foreach {x y} {n 0 i 1 l 2 f 3 d 4 s 5 b 6 t 7 o 8} {
        vq set @m $col 0 $x
        vq set @m $col 1 [expr {$y+16}]
        incr col
    }
    set m
} {mutable @m {} {} {}\
    {0 9} {0 9} {n i l f d s b t o} {0 9} {0 9} {16 17 18 19 20 21 22 23 24} {}}

test 6 {empty data table} {
    set t [vq new $m]
} {data {mutable @m {} {} {}\
            {0 9} {0 9} {n i l f d s b t o}\
            {0 9} {0 9} {16 17 18 19 20 21 22 23 24} {}} 0}

test 7 {starts with no rows} {
    vq size $t
} 0

test 8 {grow to 2 rows} {
    vq unset @t 1 0
    vq size $t
} 2

test 9 {} {
    set t
} {mutable @t {} {} {} {1 2} {} {} {} {} {} {} {} {} {} {}}

test 10 {show empty table} {
    set t
} {mutable @t {} {} {} {1 2} {} {} {} {} {} {} {} {} {} {}}

test 11 {all cells are empty} {
    set r {}
    foreach x {0 1 2 3 4 5 6 7 8} {
        lappend r [vq empty $t 0 $x] [vq empty $t 1 $x]
    }
    set r
} {1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1}

test 12 {all cell accesses return defaults} {
    set r {}
    foreach {x y} {0 99 1 88 2 77 3 66 4 55 5 44 6 33 7 22 8 11} {
        lappend r [vq at $t 0 $x $y] [vq at $t 1 $x $y]
    }
    set r
} {99 99 88 88 77 77 66.0 66.0 55.0 55.0 44 44 33 33 22 22 11 11}

test 13 {fill entire data table} {
    foreach x {0 1 2 3 4 5 6 7 8} {
        vq set @t 0 $x 1
        vq set @t 1 $x $x
    }
    set t
} {mutable @t {} {} {}\
    {1 2} {} {}\
    {0 2} {0 2} {1 1}\
    {0 2} {0 2} {1 2}\
    {0 2} {0 2} {1.0 3.0}\
    {0 2} {0 2} {1.0 4.0}\
    {0 2} {0 2} {1 5}\
    {0 2} {0 2} {1 6}\
    {0 2} {0 2} {1 7}\
    {0 2} {0 2} {1 8}}

test 14 {all cells are non-empty} {
    set r {}
    foreach x {0 1 2 3 4 5 6 7 8} {
        lappend r [vq empty $t 0 $x] [vq empty $t 1 $x]
    }
    set r
} {1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0}

test 15 {} {
    vdump $t
} { \
  n  i  l  f    d    s  b  t  o
  -  -  -  ---  ---  -  -  -  -
  ?  1  1  1.0  1.0  1  1  1  1
  ?  1  2  3.0  4.0  5  6  7  8}

test 16 {unset some data} {
    foreach x {0 1 2 3 4 5 6 7 8} {
        vq unset @t [expr {$x%2}] $x
    }
    set t
} {mutable @t {} {} {}\
    {0 2} {} {}\
    {0 2} {0 1} 1\
    {0 2} {1 2} 2\
    {0 2} {0 1} 1.0\
    {0 2} {1 2} 4.0\
    {0 2} {0 1} 1\
    {0 2} {1 2} 6\
    {0 2} {0 1} 1\
    {0 2} {1 2} 8}

test 17 {data table with some missing values} {
    set t [vq new $m]
    foreach x {0 1 2 3 4 5 6 7 8} {
        vq set @t 1 $x $x
    }
    set t
} {mutable @t {} {} {}\
    {}\
    {1 2} {0 1} 1\
    {1 2} {0 1} 2\
    {1 2} {0 1} 3.0\
    {1 2} {0 1} 4.0\
    {1 2} {0 1} 5\
    {1 2} {0 1} 6\
    {1 2} {0 1} 7\
    {1 2} {0 1} 8}

test 18 {get all values} {
    set r {}
    foreach x {0 1 2 3 4 5 6} {
        lappend r [vq at $t 0 $x 99] [vq at @t 1 $x 99]
    }
    set r
} {99 99 99 1 99 2 99.0 3.0 99.0 4.0 99 5 99 6}

test 19 {} {
    vdump $t
} { \
  n  i  l  f    d    s  b  t  o
  -  -  -  ---  ---  -  -  -  -
  ?  ?  ?  ?    ?    ?  ?  ?  ?
  ?  1  2  3.0  4.0  5  6  7  8}

test 20 {set and unset some values} {
    vq set @t 0 4 0.1
    vq unset @t 0 5 ;# redundant
    foreach x {0 1 2 3 4 5 6 7 8} {
        vq unset @t [expr {$x%2}] $x
        vq set @t [expr {(3*$x)%2}] $x [expr {$x+$x}]
    }
    set t
} {mutable @t {} {} {}\
    {0 1} {} {}\
    {1 2} {0 1} 2\
    {0 2} {0 2} {4 2}\
    {1 2} {0 1} 6.0\
    {0 2} {0 2} {8.0 4.0}\
    {0 2} {1 2} 10\
    {0 2} {0 2} {12 6}\
    {1 2} {0 1} 14\
    {0 2} {0 2} {16 8}}
  
test 21 {get all values again} {
    set r {}
    foreach x {0 1 2 3 4 5 6 7 8} {
        lappend r [vq at $t 0 $x 99] [vq at @t 1 $x 99]
    }
    set r
} {99 99 99 2 4 2 99.0 6.0 8.0 4.0 99 10 12 6 99 14 16 8}

test 22 {} {
    vdump $t
} { \
  n  i  l  f    d    s   b   t   o 
  -  -  -  ---  ---  --  --  --  --
  ?  ?  4  ?    8.0  ?   12  ?   16
  ?  2  2  6.0  4.0  10  6   14  8 }

test 23 {set over existing data} {
    set t [vq iota 5 N]
    vq set @t 2 0 99
    set t
} {mutable @t {} {} {} {2 3} {0 1} 99}

test 24 {unset over existing data} {
    set t [vq iota 5 N]
    vq unset @t 2 0
    set t
} {mutable @t {} {} {} {2 3} {} {}}

test 25 {get empty state of modified iota} {
    set r {}
    foreach i {0 1 2 3 4} { lappend r [vq empty $t $i 0]}
    set r
} {0 0 1 0 0}

test 26 {get contents of modified iota} {
    set r {}
    foreach i {0 1 2 3 4} { lappend r [vq at $t $i 0 -1]}
    set r
} {0 1 -1 3 4}

test 27 {insert some empty rows} {
    set t [vq iota 4 N]
    vq replace @t 2 0 5
    set t
} {mutable @t {} {} {2 7} {}}

test 28 {delete some rows} {
    set t [vq iota 9 N]
    vq replace @t 2 5 0
    set t
} {mutable @t {2 7} {} {} {}}

test 29 {delete some rows, then insert some empty ones} {
    set t [vq iota 9 N]
    vq replace @t 2 5 0
    vq replace @t 2 0 3
    set t
} {mutable @t {2 7} {} {2 5} {}}

test 30 {insert some empty rows, then delete inside} {
    set t [vq iota 4 N]
    vq replace @t 2 0 5
    vq replace @t 3 3 0
    set t
} {mutable @t {} {} {2 4} {}}

test 31 {insert some empty rows, then delete around} {
    set t [vq iota 6 N]
    vq replace @t 3 0 3
    vq replace @t 2 5 0
    set t
} {mutable @t {2 4} {} {} {}}

test 32 {insert some filled rows} {
    set t [vq iota 4 N]
    vq replace @t 2 0 [vq iota 5 N]
    set t
} {mutable @t {} {} {2 7} {2 7} {0 5} {0 1 2 3 4}}

test 33 {insert some empty, then filled rows} {
    set t [vq iota 4 N]
    vq replace @t 2 0 2
    vq replace @t 3 0 [vq iota 5 N]
    set t
} {mutable @t {} {} {2 9} {3 8} {0 5} {0 1 2 3 4}}

test 34 {insert some rows, then delete inside} {
    set t [vq iota 4 N]
    vq replace @t 2 0 [vq iota 5 N]
    vq replace @t 3 3 0
    set t
} {mutable @t {} {} {2 4} {2 4} {0 2} {0 4}}

test 35 {insert some rows, then delete around} {
    set t [vq iota 6 N]
    vq replace @t 3 0 [vq iota 3 N]
    vq replace @t 2 5 0
    set t
} {mutable @t {2 4} {} {} {}}

test 36 {more ranges} {
    set t [vq iota 10 N]
    for {set x 9} {$x >= 0} {incr x -1} {
        vq replace @t $x 0 2
    }
    vq set @t 28 0 -1
    set t
} {mutable @t {} {} {0 2 3 5 6 8 9 11 12 14 15 17 18 20 21 23 24 26 27 29}\
    {28 29} {0 1} -1}

test 37 {access to ranges} {
    set r {}
    foreach x {0 1 2 3 4 25 26 27 28 29} {
        lappend r [vq at $t $x 0 -9]
    }
    set r
} {-9 -9 0 -9 -9 -9 8 -9 -1 9}

::tcltest::cleanupTests
