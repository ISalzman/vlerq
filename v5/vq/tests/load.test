#!/usr/bin/env tclkit
# %renumber<^\s*test >%

# load module tests

source [file join [file dir [info script]] initests.tcl]

test 0 {load package} {
    package require vq
} $version

test 1 {} {
    vq desc2meta {A:S,B:I,C:F}
} {mdef {A B:I C:F}}

test 2 {} {
    vq desc2meta {A:S,B[C:I,D:F],E:T,F:L}
} {mdef {A {B {C:I D:F}} E:T F:L}}

test 3 {} {
    vq meta [vq open ../data/simple.db]
} {mdef {{v abc:I}}}

test 4 {} {
    set t [vq open ../data/simple.db]
} {data {mdef {{v abc:I}}} 1 {{data {mdef abc:I} 5 {1 22 333 4444 55555}}}}

test 5 {} {
    vdump $t
} { \
  v 
  --
  #5}

test 6 {} {
    vdump [vq at $t 0 0 ""]
} { \
  abc  
  -----
      1
     22
    333
   4444
  55555}

test 7 {} {
    vq meta [vq open ../data/alltypes.db]
} {mdef {{v {i0:I i1:I i2:I i4:I i8:I i16:I i32:I l:L f:F d:D s b:B}}}}

test 8 {} {
    set t [vq open ../data/alltypes.db]
} {data {mdef {{v {i0:I i1:I i2:I i4:I i8:I i16:I i32:I l:L f:F d:D s b:B}}}} 1\
    {{data {mdef {i0:I i1:I i2:I i4:I i8:I i16:I i32:I l:L f:F d:D s b:B}} 5\
        {0 0 0 0 0}\
        {1 0 1 0 1}\
        {1 2 1 0 3}\
        {1 6 13 12 3}\
        {-127 -106 -51 -36 -125}\
        {-32767 -32746 -32435 -28324 22787}\
        {1 22 333 4444 55555}\
        {111 222222 333333333 444444444444 555555555555555}\
        {1.5 22.5 333.5 4444.5 55555.5}\
        {11.1 2222.1 333333.1 44444444.1 5555555555.1}\
        {s1 s22 s333 s4444 s55555}\
        {b11 b2222 b333333 b44444444 b5555555555}}}}

test 9 {} {
    vdump $t
} { \
  v 
  --
  #5}

test 10 {} {
    set s [vdump [vq at $t 0 0 ""]]
    # hack: squeeze the output to fit one one line by removing some spaces
    set s [regsub -all -line \
            {^ (...) (...) (...) (...) (.{5}) (.{7})} $s {\1\2\3\4\5\6}]
    set s [regsub -all -line \
            { (.{6}) (.{16}) (.{8}) (.{13}) (.{7}) (....)$} $s {\1\2\3\4\5\6}]
} {\
 i0 i1 i2 i4 i8   i16    i32   l               f       d            s      b  
 -- -- -- -- ---- ------ ----- --------------- ------- ------------ ------ ---
  0  1  1  1 -127 -32767     1             111     1.5         11.1 s1      3b
  0  0  2  6 -106 -32746    22          222222    22.5       2222.1 s22     5b
  0  1  1 13  -51 -32435   333       333333333   333.5     333333.1 s333    7b
  0  0  0 12  -36 -28324  4444    444444444444  4444.5   44444444.1 s4444   9b
  0  1  3  3 -125  22787 55555 555555555555555 55555.5 5555555555.1 s55555 11b}

test 11 {} {
    vq load [readfile ../data/simple.db -binary]
} {data {mdef {{v abc:I}}} 1 {{data {mdef abc:I} 5 {1 22 333 4444 55555}}}}

::tcltest::cleanupTests
