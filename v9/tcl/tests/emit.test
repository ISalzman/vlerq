# V9 convert a view to a Metakit-compatible data format
# 2009-05-08 <jcw@equi4.com> http://opensource.org/licenses/mit-license.php
# $Id$
# %renumber<^\s*test emit->%

source [file join [file dirname [info script]] setup.tcl]

test emit-0 {load and check V9x package} { package require V9x } $version

# tiny.db - little-endian (not Metakit-compatible: no top-level views)
#   abc:I
set T [binary format H* [join {
    4a4c1a000000002c05002c004d01ae08672b80856162633a49858a888000
    00000000001c8000000a00000012
} ""]]

# tiny.db - big-endian (not Metakit-compatible: no top-level views)
#   abc:I
set U [binary format H* [join {
    4c4a1a000000002c0005002c014d08ae2b6780856162633a49858a888000
    00000000001c8000000a00000012
} ""]]

test emit-1 {proper length of the $T and $U datasets} {
    list [string length $T] [string length $U]
} {44 44}

test emit-2 {emit data for a simple view} {
    set D [v9 emit [v9 def abc:I 5 44 333 2222 11111]]
    string length $D
} 44

test emit-3 {compare with known result} {
    switch $tcl_platform(byteOrder) {
        littleEndian    { string compare $D $T }
        bigEndian       { string compare $D $U }
    }
} 0

test emit-3 {emit and map back, then dump the resulting view} {
    v9 dump [list vmap $D]
} { \
  abc  
  -----
      5
     44
    333
   2222
  11111}

cleanup {D T U}
