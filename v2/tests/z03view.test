#!/usr/bin/tclsh
# z03view.test -=- test suite for low-level view-specific code
# %renumber<^test >%

set uses {thrill}
source [file join [file dirname [info script]] initests.tcl]
interp alias {} vcall {} ::thrill::vcall
vsetup

test 0 {thrive vm has been set up} {
  regexp {^::thrive_\d+$} $::thrill::v::ws
} 1

test 1 {Dict0/1 have been set up} {
  vcall { ( Dict0 ^type Dict0 ^count Dict0 ^info b2i 
	    Dict1 ^type Dict1 ^count Dict1 ^info b2i ) } 
} {row 1 3 row 1 3}

test 2 {Dict col 0 & 1 contents} {
  vcall { ( Dict0 dup 0 ^at swap 1 ^at
	    Dict1 dup 0 ^at swap 1 ^at ) }
} {0 1 1 0}

test 3 {Dict subview sizes} {
  vcall { Dict0 1 box { 2 ^at dup ^count swap ^info b2i 2 pack } map* }
} {{3 3}}

test 4 {Dict subview contents} -body {
  vcall {
    Dict0 1 box { 2 ^at { #r-v 3 { #rc-rx 2dup ^at nip } map* nip } map* } map*
    Dict1 1 box { 2 ^at { #r-v 3 { #rc-rx 2dup ^at nip } map* nip } map* } map*
    swap 0 b@ swap 0 b@ 2 pack
  }
} -match glob -result {{{keys 9 -1} {dups 9 -1} {cols 22 ^*}}\
		       {{name 19 -1} {type 9 -1} {subv 22 ^*}}}

test 5 {Dict subviews via getall} -body {
  vcall {
    Dict0 1 box { 2 ^at getall } map*
    Dict1 1 box { 2 ^at getall } map*
    swap 0 b@ swap 0 b@ 2 pack
  }
} -match glob -result {{keys 9 -1 dups 9 -1 cols 22 ^*}\
		       {name 19 -1 type 9 -1 subv 22 ^*}}

test 6 {data stack is empty} {
  vfinish
} {}

cleanupTests

# vim: set ft=tcl :
