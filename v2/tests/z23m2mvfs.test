#!/usr/bin/tclsh
# z23m2mvfs.test -=- test suite for the vfs::m2m driver
# %renumber<^test >%

set uses {thrill ratcl}
source [file join [file dirname [info script]] initests.tcl]

package ifneeded vfs::m2m 1.3 [list source ../src/m2mvfs.tcl]

test 0 {} vfs {
  package require vfs::m2m
} 1.3

test 1 {} vfs {
  vfs::m2m::Mount "" mem
} {m2m}

test 2 {} -constraints vfs -body {
  set ::vfs::m2m::v::debug 1
  vfs::unmount mem
} -output "local mem #dirs 1 #files 0\n"

test 3 {} vfs {
  vfs::m2m::Mount m2m.tmp mem
} {m2m}

test 4 {} vfs {
  glob -nocomplain mem/*
} {}

test 5 {} -constraints vfs -body {
  set fd [open mem/aa w]
} -match glob -result {rechan?*}

test 6 {} vfs {
  glob -nocomplain mem/*
} mem/aa

test 7 {} vfs {
  file size mem/aa
} 0

test 8 {} vfs {
  puts $fd haha
  close $fd
  file size mem/aa
} 5

test 9 {} vfs {
  file mkdir mem/d
} {}

test 10 {} vfs {
  set fd [open mem/d/ff w]
  puts $fd wow
  close $fd
  file size mem/d/ff
} 4

test 11 {} vfs {
  set fd [open mem/d/eee w]
  puts $fd ha
  close $fd
  file size mem/d/eee
} 3

test 12 {} vfs {
  glob mem/*
} {mem/aa mem/d}

test 13 {} vfs {
  glob mem/d/*
} {mem/d/ff mem/d/eee}

test 14 {} -constraints vfs -body {
  vfs::unmount mem
} -output "local mem #dirs 2 #files 3\n"

test 15 {} vfs {
  file size m2m.tmp
} 188

test 16 {} vfs {
  #puts [exec hexdump -C m2m.tmp]
  file delete m2m.tmp
} {}

cleanupTests

# vim: set ft=tcl :
