#!/usr/bin/tclsh
# z12blocked.test -=- test suite for blocked metakit files
# %renumber<^test >%

set uses {thrill ratcl}
source [file join [file dirname [info script]] initests.tcl]

test 0 {open mk file} -body {
  set D [vopen ../noarch/mkblk.db]
} -match glob -result {^*}

test 1 {root size} {
  view $D get #
} 1

test 2 {root names} {
  view $D info names
} {bv}

test 3 {root types} {
  view $D info types
} {V}

test 4 {subview names} {
  set U [view $D get 0 bv]
  view $U info names
} {_B}

test 5 {block count} {
  view $U get #
} 11

test 6 {block sizes} {
  view $U counts _B
} {999 999 999 999 999 999 999 999 999 1000 9}

test 7 {subview real names} {
  set x [view $U get 0 _B]
  list [view $x info names] [view $x info types] [view $x get #]
} {{k1 k2} {S I} 999}

test 8 {blocked size} {
  set B [view $U blocked]
  view $B get #
} 10000

test 9 {first blocked rows} {
  view $B first 10 | get
} {s_0 0 s_1 1 s_2 2 s_3 3 s_4 4 s_5 5 s_6 6 s_7 7 s_8 8 s_9 9}

test 10 {last blocked rows} {
  view $B last 10 | project k2 | get
} {9990 9991 9992 9993 9994 9995 9996 9997 9998 9999}

test 11 {a few blocked rows} {
  view $B slice 995 4 1 | project k2 | get
} {995 996 997 998}

test 12 {more blocked rows} {
  view $B slice 1500 10 1 | project k2 | get
} {1500 1501 1502 1503 1504 1505 1506 1507 1508 1509}

test 13 {later blocked rows} {
  view $B slice 9500 10 1 | project k2 | get
} {9500 9501 9502 9503 9504 9505 9506 9507 9508 9509}

test 14 {single rows} {
  list [view $B get 998] [view $B get 999] [view $B get 1000]
} {{s_998 998} {s_999 999} {s_1000 1000}}

test 15 {spanning rows} {
  view $B slice 995 10 1 | project k2 | get
} {995 996 997 998 999 1000 1001 1002 1003 1004}

test 16 {data stack is empty} {
  vfinish
} {}

cleanupTests

# vim: set ft=tcl :
