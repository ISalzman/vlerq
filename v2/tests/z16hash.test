#!/usr/bin/tclsh
# z16hash.test -=- test suite for the hashing code
# %renumber<^test >%

set uses {thrill ratcl}
source [file join [file dirname [info script]] initests.tcl]

test 0 {thrive vm has been set up} {
  regexp {^::thrive_\d+$} $::thrill::v::ws
} 1

test 1 {hnew} {
  set v [::thrill::vcall hnew SS S S]
  list [view $v info names] [view $v info types] [view $v get #]
} {{k v} {S S} 0}

test 2 {hset} {
  foreach {x y} {
    one un
    two deux
    one one
    trois drei
  } {
    ::thrill::vcall hset nVSS {} $v $x $y
  }
  view $v get
} {one one two deux trois drei}

test 3 {hdel found} {
  ::thrill::vcall hdel nSV {} two $v
  view $v get
} {one one trois drei}

test 4 {hdel not found} {
  ::thrill::vcall hdel nSV {} deux $v
  view $v get
} {one one trois drei}

test 5 {hset again} {
  ::thrill::vcall hset nVSS {} $v four vier
  view $v get
} {one one trois drei four vier}

test 6 {find match} {
  ::thrill::vcall hfnd SV four $v
} vier

test 7 {find no match} {
  ::thrill::vcall hfnd SV two $v
} {}

test 8 {hash with ints} {
  set w1 [::thrill::vcall hnew SS I I]
  foreach {x y} {
    1 1
    2 22
    1 111
    3 3333
  } {
    ::thrill::vcall hset nVII {} $w1 $x $y
  }
  view $w1 get
} {1 111 2 22 3 3333}

test 9 {hash with views as keys} {
  set k1 [vdef a:I {1}]
  set k2 [vdef a:I {2 2}]
  set k3 [vdef a:I {3 3 3}]
  set w2 [::thrill::vcall hnew SS V I]
  foreach {x y} [list $k1 1 $k2 22 $k1 333 $k3 4444] {
    ::thrill::vcall hset nVVI {} $w2 $x $y
  }
  set r {}
  foreach {x y} [view $w2 get] { lappend r [view $x get] $y }
  set r
} {1 333 {2 2} 22 {3 3 3} 4444}

test 10 {hash with views as keys and values} {
  set v1 [vdef b:S {one}]
  set v2 [vdef b:S {two two}]
  set v3 [vdef b:S {three three three}]
  set v4 [vdef b:S {four four four four}]
  set w2 [::thrill::vcall hnew SS V V]
  foreach {x y} [list $k1 $v1 $k2 $v2 $k1 $v3 $k3 $v4] {
    ::thrill::vcall hset nVVV {} $w2 $x $y
  }
  set r {}
  foreach x [view $w2 get] { lappend r [view $x get] }
  #puts [view $w2 html]
  set r
} {1 {three three three} {2 2} {two two} {3 3 3} {four four four four}}

test 11 {hash with many ints so it has to resize a few times} {
  set w3 [::thrill::vcall hnew SS I I]
  for {set i 0} {$i < 1000} {incr i} {
    ::thrill::vcall hset nVII {} $w3 $i -$i
  }
  set t [view $w3 get]
  concat [llength $t] [lrange $t 0 9] [lrange $t end-9 end]
} {2000 0 0 1 -1 2 -2 3 -3 4 -4 995 -995 996 -996 997 -997 998 -998 999 -999}

test 12 {data stack is empty} {
  vfinish
} {}

cleanupTests

# vim: set ft=tcl :
