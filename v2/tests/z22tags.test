#!/usr/bin/tclsh
# z22tags.test -=- test suite for view tags and introspection
# %renumber<^test >%

set uses {thrill ratcl}
source [file join [file dirname [info script]] initests.tcl]

test 0 {setup test data} {
  set R [vdef A B C   {a b c d a f c b d}]
  set S [vdef D E F   {b g a d a f}]
  set T [vdef A B C D {a b c d a b e f b c e f e d c d e d e f a b d e}]
  set U [vdef C D E   {c d e c d f d e f}]
  set V [vdef C D     {c d e f}]
  set W [vdef A B C   {1 2 3 a b c}]
  set X [vdef D E:I F {a 100 aa b 20 bb c 3 cc}]
  set Y [vdef D       {y}]
  set Z [vdef E       {}]
  return
} {}

test 1 {row tag} {
  view $R info tag
} row 

test 2 {row arity} {
  view $R info arity
} 0

test 3 {row args} {
  view $R info args
} {}

test 4 {pair tag} {
  set v [view $W pair $S]
  view $v info tag
} pair 

test 5 {pair arity} {
  view $v info arity
} 2

test 6 {pair arg count} {
  set a [view $v info args]
  llength $a
} 2

test 7 {pair args} {
  list [view [lindex $a 0] info names] [view [lindex $a 1] info names]
} {{A B C} {D E F}}

test 8 {mutable change} {
  set v [view $R set 1 1 X]
  view $v get
} {a b c d X f c b d} 

test 9 {mut tag} {
  view $v info tag
} mut 

test 10 {mut arity} {
  view $v info arity
} 4

test 11 {mut first arg} {
  view [lindex [view $R info args] 0] describe
} {\
 -mut
  +-view
  | +-A:S
  | +-B:S
  | +-C:S
  +-vec
  +-vec
  +-view
    +-A:S
    +-B:S
    +-C:S}

test 12 {describe test} {
  view $R describe
} {\
 -mut
  +-view
  | +-A:S
  | +-B:S
  | +-C:S
  +-vec
  +-vec
  +-view
    +-A:S
    +-B:S
    +-C:S}

test 13 {describe operator} {
  view $W pair $S | describe
} {\
 -pair
  +-view
  | +-A:S
  | +-B:S
  | +-C:S
  +-view
    +-D:S
    +-E:S
    +-F:S}

test 14 {describe other args} {
view $R rename 0 AA 1 BB 2 CC | describe
} {\
 -rename
  +-mut
  | +-view
  | | +-A:S
  | | +-B:S
  | | +-C:S
  | +-vec
  | +-vec
  | +-view
  |   +-A:S
  |   +-B:S
  |   +-C:S
  +-vec
  +-vec}

test 15 {data stack is empty} {
vfinish
} {}

cleanupTests

# vim: set ft=tcl :
