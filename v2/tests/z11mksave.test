#!/usr/bin/tclsh
# z11mksave.test -=- test suite for the mk save code
# %renumber<^test >%

set uses {thrill ratcl}
source [file join [file dirname [info script]] initests.tcl]

test 0 {create a suitable top-level} {
  set R [vdef X A B C {x a b c x d a f x c b d}]
  set V [view $R group X V | project V]
  view $V dump
} { \
  V 
  --
  #3}

test 1 {check its subview} {
  view $V | get 0 0 | dump
} { \
  A  B  C
  -  -  -
  a  b  c
  d  a  f
  c  b  d}

test 2 {save as mk file} {
  set r [view $V save z11temp.db]
  #puts [exec hexdump -C z11temp.db]
  set r
} 87

test 3 {load mk file back in} {
  set L [vopen z11temp.db]
  catch { file delete z11temp.db }
  view $L dump
} { \
  V 
  --
  #3}

test 4 {check loaded subview} {
  view $L | get 0 0 | dump
} { \
  A  B  C
  -  -  -
  a  b  c
  d  a  f
  c  b  d}

test 5 {save one mk file as another} {
  set x [vopen ../noarch/gtest.db]
  set fd [open z11temp2.db w]
  fconfigure $fd -translation binary
  set r [view $x save -to $fd]
  close $fd
  #puts [exec hexdump -C z11temp2.db]
  set r
} 590

test 6 {load mk file back in} {
  set L [vopen z11temp2.db]
  catch { file delete z11temp2.db }
  view $L dump
} { \
  frequents  likes  serves
  ---------  -----  ------
        #10     #8      #9}

test 7 {check loaded subview} {
  set f [view $L | get 0 frequents]
  list [view $f info names] [view $f info types] [view $f get #]
} {{drinker bar perweek} {S S I} 10}

test 8 {check actual subview contents} {
  view $L | get 0 likes | dump
} { \
  drinker  beer          perday
  -------  ------------  ------
  adam     bud                2
  wilt     rollingrock        1
  sam      bud                2
  norm     rollingrock        3
  norm     bud                2
  nan      sierranevada       1
  woody    pabst              2
  lola     mickies            5}

test 9 {save as string} memchan {
  string length [view $L save]
} 590

test 10 {save and reload as string} memchan {
  set s [view $R save]
  view [vopen -data $s] get
} {x a b c x d a f x c b d}

test 11 {save and reload via channel} memchan {
  set fd [::thrill::do_memchan]
  view $R save -to $fd
  seek $fd 0
  view [vopen -from $fd] get
} {x a b c x d a f x c b d}

test 12 {save derived as mk file} memchan {
  set s [view [vdef A:I {1 2}] concat [vdef A:I {3 4 5}] | save z11temp3.db]
  #puts [exec hexdump -C z11temp3.db]
  file size z11temp3.db
} 37

test 13 {data stack is empty} {
  catch { file delete z11temp3.db }
  vfinish
} {}

cleanupTests

# vim: set ft=tcl :
