#!/usr/bin/env tclsh
# %renumber<^\s*test >%

source [file join [file dir [info script]] initests.tcl]

test 0 {} {
    package require tvq
} $version

test 1 {perform a basic call} {
    tvq "gi" type 123
} number

test 2 {} skip {
    tvq "gs" print "Hello from Tcl!"
} {}

proc luas {s} { tvq "o" [tvq "gs" loadstring $s] }  ;# evaluate string in lua
luas { package.loaded['lvq.core'] = lvq }           ;# emulate module setup
tvq "ggsc" rawset _G tcl ""                         ;# define a 'tcl' callback

test 3 {run the lvq.lua wrapper} {
    # emulate a require, but from a specific file
    tvq os [tvq "gs" loadfile "../lvq/src/lvq.lua"] lvq
} {}

test 4 {lua error handling} {
    list [catch { tvq "gt" assert 0 } e] $e
} {1 {assertion failed!}}

test 5 {string evaluation in lua} {
    luas { return 1+2*3 }
} 7

test 6 {} skip {
    tvq "gs" dofile "../lvq/tests/test.lua"
} {}

test 7 {tcl callback} {
    tvq "gss" tcl return "a b c"
} "a b c"

test 8 {errors in tcl callback} {
    list [catch { tvq "gs" tcl set } e] $e
} {1 {tvq: wrong # args: should be "set varName ?newValue?"}}

test 9 {output in tcl callback} -body {
    tvq "gss" tcl puts "Hello from Lua!"
} -output "Hello from Lua!\n"

test 10 {error in lua} {
    list [catch { tvq "g" io } e] $e
} {1 {attempt to call a table value}}

test 11 {fetch entry from vops table} -body {
    tvq "go" tostring [tvq "ggs" rawget vops meta]
} -match glob -result {function: 0x*}

::tcltest::cleanupTests
