#!/usr/bin/env tclkit
# %renumber<^\s*test >%

source [file join [file dir [info script]] initests.tcl]

test 0 "load ratcl package" {
    package require ratcl
} $version

test 1 "display a meta-view" {
    tvq dump {A,B[C:I],D:s}
} { \
  name  type  subv
  ----  ----  ----
  A        5    #0
  B        7    #1
  D       21    #0}

test 2 "create and display an empty view" {
    tvq dump {view 0 {A,B[C:I],D:s}}
} { \
  A  B  D
  -  -  -}

test 3 "create and display a view with no data" {
    tvq dump {view 2 {A,B[C:I],D:s}}
} { \
  A  B  D
  -  -  -
         
         }

test 4 "" {
    tvq dump [tvq meta {A,B[C:I],D:s}]
} { \
  name  type  subv
  ----  ----  ----
  name     5    #0
  type     1    #0
  subv     7    #0}

test 5 "" -body {
    tvq view {meta {A,B[C:I],D:s}}
} -match glob -result {tvqobj: 0x*} ;# TODO: would like "name:S,type:I,subv:V"

test 6 "" {
    tvq dump {meta {A,B[C:I],D:s}}
} { \
  name  type  subv
  ----  ----  ----
  name     5    #0
  type     1    #0
  subv     7    #0}

test 7 "" {
    tvq struct [tvq open ../etc/alltypes.db]
} (IIIIIIILFDSB)

test 8 "" {
    tvq struct {open ../etc/alltypes.db}
} (IIIIIIILFDSB)

test 9 "" -body {
    tvq row {open ../etc/alltypes.db} 0
} -match glob -result {tvqobj: 0x*}

test 10 "" {
    tvq dump {at {open ../etc/simple.db} 0 0}
} { \
  abc  
  -----
      1
     22
    333
   4444
  55555}

test 11 "trivial pipeline" {
    V 5 tag N | dump |
} { \
  N
  -
  0
  1
  2
  3
  4}

test 12 "simple get" {
    set v [V 5 tag N]
    V $v pair $v | get |
} {0 0 1 1 2 2 3 3 4 4}

test 13 "meta column get" {
    set v [V "" meta | meta]
    V $v get * 0 |
} {name type subv}

test 14 "meta row get" {
    V $v get 0 * |
} {name 5 {}}

test 15 "meta row tagged get" {
    V $v get 0 |
} {name name type 5 subv {}}

test 16 "meta row tagged get all" {
    V $v get * |
} {{name 5 {}} {type 1 {}} {subv 7 {}}}

test 17 "meta column get by name" {
    V $v get * type |
} {5 1 7}

test 18 "get from file" {
    set db [V ../etc/lkit-le.db open |]
    V $db meta | dump |
} { \
  name  type  subv
  ----  ----  ----
  dirs     7    #3}
  
test 19 "structure from file" {
    V $db struct |
} (SI(SIIB))

test 20 "get all data types as subview" {
    V ../etc/alltypes.db open | get
} {{data i0:I,i1:I,i2:I,i4:I,i8:I,i16:I,i32:I,l:L,f:F,d:D,s:S,b:B 5\
    {0 0 0 0 0} {1 0 1 0 1} {1 2 1 0 3} {1 6 13 12 3}\
    {-127 -106 -51 -36 -125}\
    {-32767 -32746 -32435 -28324 22787}\
    {1 22 333 4444 55555}\
    {111 222222 333333333 444444444444 555555555555555}\
    {1.5 22.5 333.5 4444.5 55555.5}\
    {11.1 2222.1 333333.1 44444444.1 5555555555.1}\
    {s1 s22 s333 s4444 s55555} {b11 b2222 b333333 b44444444 b5555555555}}}

test 21 "get all data types as values" {
    V ../etc/alltypes.db open | get 0 v * *
} {0 1 1 1 -127 -32767 1 111 1.5 11.1 s1 b11\
   0 0 2 6 -106 -32746 22 222222 22.5 2222.1 s22 b2222\
   0 1 1 13 -51 -32435 333 333333333 333.5 333333.1 s333 b333333\
   0 0 0 12 -36 -28324 4444 444444444444 4444.5 44444444.1 s4444 b44444444\
   0 1 3 3 -125 22787 55555 555555555555555\
                        55555.5 5555555555.1 s55555 b5555555555}

#test 22 "get from file" {
#    V $db get 0 dirs | dump |
#} {}

::tcltest::cleanupTests
