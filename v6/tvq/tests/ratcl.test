#!/usr/bin/env tclkit
# %renumber<^\s*test >%

source [file join [file dir [info script]] initests.tcl]

test 0 {load ratcl package} {
    package require ratcl
} $version

test 1 {display a meta-view} {
    tvq dump {A,B[C:I],D:s}
} { \
  name  type  subv
  ----  ----  ----
  A        5    #0
  B        7    #1
  D       21    #0}

test 2 {create and display an empty view} {
    tvq dump {view 0 {A,B[C:I],D:s}}
} { \
  A  B  D
  -  -  -}

test 3 {create and display a view with no data} {
    tvq dump {view 2 {A,B[C:I],D:s}}
} { \
  A  B  D
  -  -  -
         
         }

test 4 {} {
    tvq dump [tvq meta {A,B[C:I],D:s}]
} { \
  name  type  subv
  ----  ----  ----
  name     5    #0
  type     1    #0
  subv     7    #0}

test 5 {} -body {
    tvq view {meta {A,B[C:I],D:s}}
} -match glob -result {tvqobj: 0x*} ;# TODO: would like "name:S,type:I,subv:V"

test 6 {} {
    tvq dump {meta {A,B[C:I],D:s}}
} { \
  name  type  subv
  ----  ----  ----
  name     5    #0
  type     1    #0
  subv     7    #0}

test 7 {} {
    tvq struct [tvq open ../etc/alltypes.db]
} (IIIIIIILFDSB)

test 8 {} {
    tvq struct {open ../etc/alltypes.db}
} (IIIIIIILFDSB)

test 9 {} -body {
    tvq row {open ../etc/alltypes.db} 0
} -match glob -result {tvqobj: 0x*}

test 10 {} {
    tvq dump {at {open ../etc/simple.db} 0 0}
} { \
  abc  
  -----
      1
     22
    333
   4444
  55555}

test 11 {trivial pipeline} {
    V 5 tag N | dump |
} { \
  N
  -
  0
  1
  2
  3
  4}

test 12 {simple get} {
    set v [V 5 tag N]
    V $v pair $v | get |
} {0 0 1 1 2 2 3 3 4 4}

test 13 {meta column get} {
    set v [V "" meta | meta]
    V $v get * 0
} {name type subv}

test 14 {meta row get} {
    V $v get 0 *
} {name 5 {}}

test 15 {meta row tagged get} {
    V $v get 0
} {name name type 5 subv {}}

test 16 {meta row tagged get all} {
    V $v get *
} {{name 5 {}} {type 1 {}} {subv 7 {}}}

test 17 {meta column get by name} {
    V $v get * type
} {5 1 7}

test 18 {get from file} {
    set db [V ../etc/lkit-le.db open]
    V $db meta | dump
} { \
  name  type  subv
  ----  ----  ----
  dirs     7    #3}
  
test 19 {structure from file} {
    tvq struct $db
} (SI(SIIB))

::tcltest::cleanupTests
